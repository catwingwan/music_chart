# music_chart_mvp.py
# MVP: è‡ªå‹•å»ºç«‹æ­Œæ›²æ’è¡Œæ¦œï¼Œç”Ÿæˆ HTMLï¼Œä¸¦è‡ªå‹•ç™¼ä½ˆåˆ° Bloggerï¼ˆå« AI è§£èªªæ®µè½ï¼‰

import requests
import pandas as pd
import urllib.parse
from dotenv import load_dotenv
import os
import json
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build
from io import StringIO
from datetime import datetime, timedelta

# === è¼‰å…¥ç’°å¢ƒè®Šæ•¸ ===
load_dotenv()

# === CONFIG ===
SPOTIFY_CLIENT_ID = os.getenv("SPOTIFY_CLIENT_ID") or "YOUR_SPOTIFY_CLIENT_ID"
SPOTIFY_CLIENT_SECRET = os.getenv("SPOTIFY_CLIENT_SECRET") or "YOUR_SPOTIFY_CLIENT_SECRET"
YOUTUBE_API_KEY = os.getenv("YOUTUBE_API_KEY") or "YOUR_YOUTUBE_API_KEY"
BLOGGER_CLIENT_SECRET = os.getenv("BLOGGER_CLIENT_SECRET") or "client_secret.json"
BLOG_ID = os.getenv("BLOG_ID") or "YOUR_BLOG_ID"
TOKEN_PATH = "token.json"

# === åˆå§‹åŒ– log è³‡æ–™å¤¾ ===
os.makedirs("logs", exist_ok=True)
os.makedirs("logs/raw", exist_ok=True)

# === Spotify æˆæ¬Š ===
def get_spotify_token():
    resp = requests.post("https://accounts.spotify.com/api/token",
        data={"grant_type": "client_credentials"},
        auth=(SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET))
    if resp.status_code != 200:
        print(f"âš  ç„¡æ³•å–å¾— Spotify tokenï¼š{resp.status_code} - {resp.text}")
        return None
    token = resp.json().get("access_token")
    print(f"ğŸ« æˆåŠŸå–å¾— Spotify token: {token[:10]}...")
    return token

# === æ’­æ”¾æ¸…å–®æœå°‹ API ===
def search_playlist(query, token):
    url = f"https://api.spotify.com/v1/search?q={urllib.parse.quote(query)}&type=playlist&limit=1"
    headers = {"Authorization": f"Bearer {token}"}
    resp = requests.get(url, headers=headers)
    if resp.status_code != 200:
        print(f"âš  æœå°‹æ’­æ”¾æ¸…å–®å¤±æ•—ï¼š{resp.status_code} - {resp.text}")
        return None
    items = resp.json().get("playlists", {}).get("items", [])
    if not items:
        print(f"âš  æ‰¾ä¸åˆ°æ’­æ”¾æ¸…å–®ï¼š{query}")
        return None
    return items[0]["id"]

# === Spotify Top 50ï¼ˆæ’­æ”¾æ¸…å–® APIï¼‰ ===
def fetch_spotify_top_playlist(region="my", limit=10):
    token = get_spotify_token()
    if not token:
        print("âŒ Spotify token ç‚ºç©ºï¼Œçµ‚æ­¢ç²å–æ’­æ”¾æ¸…å–®")
        return []

    query_name = f"Top 50 - {region.upper()}"
    playlist_id = search_playlist(query_name, token)
    if not playlist_id:
        print(f"ğŸ” å˜—è©¦ fallback è‡³ Top 50 - Global")
        playlist_id = search_playlist("Top 50 - Global", token)
    if not playlist_id:
        print("âŒ æ‰¾ä¸åˆ°æœ‰æ•ˆæ’­æ”¾æ¸…å–® ID")
        return []

    url = f"https://api.spotify.com/v1/playlists/{playlist_id}/tracks?limit={limit}&fields=items(track(name,artists(name)))"
    headers = {"Authorization": f"Bearer {token}"}
    resp = requests.get(url, headers=headers)
    print(f"ğŸ“¡ å‘¼å« Spotify æ’­æ”¾æ¸…å–® APIï¼š{resp.status_code}")

    if resp.status_code != 200:
        print(f"âš  ç„¡æ³•ä¸‹è¼‰æ’­æ”¾æ¸…å–®ï¼ˆ{region}ï¼‰: HTTP {resp.status_code}")
        print(f"âš  éŒ¯èª¤å…§å®¹ï¼š{resp.text[:300]}")
        return []

    try:
        data = resp.json()
    except Exception as e:
        print(f"âš  JSON è§£ç¢¼å¤±æ•—ï¼š{e}")
        print(resp.text[:500])
        return []

    debug_file = f"logs/raw/spotify_raw_{region}.json"
    with open(debug_file, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    print(f"ğŸ“ åŸå§‹ JSON å·²å„²å­˜ï¼š{debug_file}")

    items = data.get("items", [])
    print(f"ğŸ” æ’­æ”¾æ¸…å–®å–å¾—æˆåŠŸï¼š{len(items)} é¦–")

    songs = []
    for item in items:
        track = item.get("track")
        if track is None:
            continue
        name = track.get("name", "")
        artists = ", ".join([artist.get("name", "") for artist in track.get("artists", [])])
        if name and artists:
            songs.append({"æ­Œæ›²åç¨±": name, "æ­Œæ‰‹": artists})

    return songs

# === æŸ¥ Spotify ç†±åº¦ ===
def fetch_spotify_popularity(song, artist, token):
    query = urllib.parse.quote(f"track:{song} artist:{artist}")
    url = f"https://api.spotify.com/v1/search?q={query}&type=track&limit=1"
    headers = {"Authorization": f"Bearer {token}"}
    resp = requests.get(url, headers=headers)
    items = resp.json().get("tracks", {}).get("items", [])
    if items:
        return items[0].get("popularity", 0)
    return 0

# === æŸ¥ YouTube æ’­æ”¾é‡ ===
def fetch_youtube_views(song, artist):
    query = urllib.parse.quote(f"{song} {artist}")
    search_url = f"https://www.googleapis.com/youtube/v3/search?part=snippet&q={query}&key={YOUTUBE_API_KEY}&maxResults=1&type=video"
    resp = requests.get(search_url).json()
    items = resp.get("items", [])
    if not items:
        return 0
    video_id = items[0].get("id", {}).get("videoId")
    if not video_id:
        return 0
    stat_url = f"https://www.googleapis.com/youtube/v3/videos?part=statistics&id={video_id}&key={YOUTUBE_API_KEY}"
    stats = requests.get(stat_url).json()
    if "items" not in stats or not stats["items"]:
        return 0
    views = stats["items"][0]["statistics"].get("viewCount", 0)
    return int(views)

# === æ•´åˆè³‡æ–™èˆ‡æ’åº ===
def build_chart(source="top50", region="my"):
    token = get_spotify_token()
    if not token:
        return pd.DataFrame()
    songs = fetch_spotify_top_playlist(region=region, limit=10)
    if not songs:
        return pd.DataFrame()

    chart = []
    for song in songs:
        yt_views = fetch_youtube_views(song['æ­Œæ›²åç¨±'], song['æ­Œæ‰‹'])
        spotify_pop = fetch_spotify_popularity(song['æ­Œæ›²åç¨±'], song['æ­Œæ‰‹'], token)
        score = (yt_views / 1000) * 0.5 + spotify_pop * 0.5
        chart.append({
            "æ­Œæ›²": song['æ­Œæ›²åç¨±'],
            "æ­Œæ‰‹": song['æ­Œæ‰‹'],
            "YTæ’­æ”¾é‡": yt_views,
            "Spotifyç†±åº¦": spotify_pop,
            "ç¸½åˆ†": round(score, 2),
            "Spotifyé€£çµ": f"https://open.spotify.com/search/{urllib.parse.quote(song['æ­Œæ›²åç¨±'] + ' ' + song['æ­Œæ‰‹'])}"
        })

    df = pd.DataFrame(chart)
    df["æ’å"] = df["ç¸½åˆ†"].rank(ascending=False, method="min").astype(int)
    return df.sort_values("æ’å")

# === ç”¢ç”Ÿ HTML è¡¨æ ¼ ===
def generate_html_table(df):
    html = '<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%; font-family:sans-serif;">'
    html += '<thead><tr style="background-color:#f2f2f2;"><th>æ’å</th><th>æ­Œæ›²</th><th>æ­Œæ‰‹</th><th>YT æ’­æ”¾</th><th>Spotify ç†±åº¦</th><th>ç¸½åˆ†</th><th>Spotify</th></tr></thead><tbody>'
    for _, row in df.iterrows():
        html += f"<tr><td>{row['æ’å']}</td><td>{row['æ­Œæ›²']}</td><td>{row['æ­Œæ‰‹']}</td><td>{row['YTæ’­æ”¾é‡']}</td><td>{row['Spotifyç†±åº¦']}</td><td>{row['ç¸½åˆ†']}</td><td><a href='{row['Spotifyé€£çµ']}' target='_blank'>ğŸµ</a></td></tr>"
    html += '</tbody></table>'
    return html

# === ç™¼ä½ˆè‡³ Bloggerï¼ˆä¿®æ­£çµæ§‹ï¼‰ ===
def publish_to_blogger(content_html, region):
    creds = None
    if os.path.exists(TOKEN_PATH):
        creds = Credentials.from_authorized_user_file(TOKEN_PATH, ['https://www.googleapis.com/auth/blogger'])
    else:
        flow = InstalledAppFlow.from_client_secrets_file(BLOGGER_CLIENT_SECRET, scopes=['https://www.googleapis.com/auth/blogger'])
        creds = flow.run_local_server(port=8080)
        with open(TOKEN_PATH, 'w') as token:
            token.write(creds.to_json())

    service = build('blogger', 'v3', credentials=creds)
    title = f"æ¯é€±æ­Œæ›²æ•¸æ“šæ¦œï¼ˆ{region.upper()}ï¼‰"

    body = {
        "title": title,
        "content": content_html
    }

    post = service.posts().insert(blogId=BLOG_ID, body=body, isDraft=False).execute()
    print(f"âœ… å·²ç™¼ä½ˆï¼š{post['title']}")

# === AI è§£èªªç”Ÿæˆï¼ˆç°¡åŒ–ï¼‰ ===
def generate_ai_summary(df):
    top3 = df.head(3)
    summary = "\n".join([f"ã€Š{row['æ­Œæ›²']}ã€‹ by {row['æ­Œæ‰‹']}" for _, row in top3.iterrows()])
    return f"æœ¬é€±å‰ 3 åæ­Œæ›²ç‚ºï¼š{summary}ï¼Œè¶¨å‹¢ä»ä»¥è¯èªæµè¡Œç‚ºä¸»ï¼"

# === ä¸»ç¨‹å¼ ===
if __name__ == "__main__":
    regions = ["my", "sg", "ph", "id"]
    for region in regions:
        print(f"ğŸ”„ ç”¢ç”Ÿ {region.upper()} æ’è¡Œæ¦œ...")
        df = build_chart(region=region)
        if df.empty:
            print("âš  ç„¡æ³•å»ºç«‹æ’è¡Œæ¦œï¼Œä¾†æºè³‡æ–™ç‚ºç©ºæˆ–å¤±æ•—ã€‚")
            continue
        html_table = generate_html_table(df)
        summary = generate_ai_summary(df)
        full_content = f"<p>{summary}</p>{html_table}"
        publish_to_blogger(full_content, region)
